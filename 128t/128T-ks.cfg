#version=DEVEL
# System authorization information
auth --enableshadow --passalgo=sha512

# Use text install
text
reboot
firstboot --disable
ignoredisk --only-use=sda
# Keyboard layouts
keyboard --vckeymap=us --xlayouts='us'
# System language
lang en_US.UTF-8

install
cdrom

# Network information
#network  --bootproto=dhcp --device=enp0s3 --ipv6=auto --activate
#network  --hostname=localhost.localdomain

# Disable firewall
firewall --disabled

# Root password
rootpw --iscrypted $6$gW/9lM4s$Tkj9KeevAqHKX03L2ShxqS82MIJZKcU5wlxaxFZUV0Of4Qz5I3eSm6EOpQ0F/xD4R88kOy0PUAtOHGYkCFf0k0
# System timezone
timezone America/New_York --isUtc
# Setup 128t user and add to wheel
user --groups=wheel --name=128t --password=$6$gW/9lM4s$Tkj9KeevAqHKX03L2ShxqS82MIJZKcU5wlxaxFZUV0Of4Qz5I3eSm6EOpQ0F/xD4R88kOy0PUAtOHGYkCFf0k0 --iscrypted --gecos="128t"
# System bootloader configuration
bootloader --location=mbr 
zerombr
autopart --type=lvm
# Partition clearing information
clearpart --all --initlabel

# Disable SELinux
selinux --disabled

###############################################################################
###############################################################################
##
##  WARNING: Do not make manual edits to the packages section; they will be 
##           discarded by the ISO generation tool when the ISO is created!!! 
##           (edits made before this comment will be carried over to the 
##           ISO kickstart file
##
###############################################################################
###############################################################################
%packages
%end
###############################################################################
##  END of generated section -- edits after this comment will be added to the 
##  ISO kickstart file
###############################################################################

%addon com_redhat_kdump --disable --reserve-mb='128'

%end

%post --nochroot --log=/mnt/sysimage/root/ks-post.log
# Enable use of sudo without password
sed -i '/^#\s*%wheel.*NOPASSWD/s/^#\s*//' /mnt/sysimage/etc/sudoers

# Setup persistent interface naming
# The first interface found will be named mgmt.  Subsequent interfaces will be named dp0, dp1, etc.
i=0
for PCIADDR in $(lspci -D | grep Ethernet | awk '{print $1}')
do
 cd "/sys/bus/pci/devices/$PCIADDR/net"
 OLDNAME=`ls`
 HWADDR=`ifconfig $OLDNAME | grep ether | awk '{print $2}'`
 if [ $i -eq 0 ]
 then
  NEWNAME="mgmt"
  rm -f /mnt/sysimage/etc/sysconfig/network-scripts/ifcfg-$OLDNAME
  cp /mnt/install/repo/ifcfg-mgmt /mnt/sysimage/etc/sysconfig/network-scripts/
  sed -i "s/HWADDR=/HWADDR=$HWADDR/" /mnt/sysimage/etc/sysconfig/network-scripts/ifcfg-mgmt
  chmod 644 /mnt/sysimage/etc/sysconfig/network-scripts/ifcfg-mgmt
 else
  NEWNAME="dp$((i-1))"
  rm -f /mnt/sysimage/etc/sysconfig/network-scripts/ifcfg-$OLDNAME
  cp /mnt/install/repo/ifcfg-dpX /mnt/sysimage/etc/sysconfig/network-scripts/ifcfg-$NEWNAME
  sed -i "s/HWADDR=/HWADDR=$HWADDR/" /mnt/sysimage/etc/sysconfig/network-scripts/ifcfg-$NEWNAME
  sed -i "s/NAME=/NAME=$NEWNAME/" /mnt/sysimage/etc/sysconfig/network-scripts/ifcfg-$NEWNAME
  chmod 644 /mnt/sysimage/etc/sysconfig/network-scripts/ifcfg-$NEWNAME
 fi
 echo "SUBSYSTEM==\"net\", ACTION==\"add\", KERNELS==\"$PCIADDR\", NAME=\"$NEWNAME\"" >> /mnt/sysimage/etc/udev/rules.d/70-persistent-interfaces.rules
 echo "Renamed $OLDNAME to $NEWNAME"
 ((i+=1))
done

# Place 128T scripts in /usr/local/bin
cp /mnt/install/repo/128t-scripts.zip /tmp
cd /tmp
unzip /tmp/128t-scripts.zip
cp /tmp/128t-scripts/* /mnt/sysimage/usr/local/bin/
chmod +x /mnt/sysimage/usr/local/bin/128t*

# Comment out default NTP servers
sed -i '/^server/s/^/#/' /mnt/sysimage/etc/ntp.conf
# Add new NTP servers
echo -en '\n\nserver 0.pool.ntp.org\nserver 1.pool.ntp.org\nserver 2.pool.ntp.org\nserver 3.pool.ntp.org\n' >> /mnt/sysimage/etc/ntp.conf
# Enable NTPD
chroot /mnt/sysimage systemctl disable chronyd
chroot /mnt/sysimage systemctl enable ntpd
%end
